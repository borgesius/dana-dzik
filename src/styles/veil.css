/* ── Veil Overlay ─────────────────────────────────────────────────────────── */

.veil-overlay {
    position: fixed;
    inset: 0;
    z-index: 200001;
    background: var(--veil-bg-color, #000000);
    opacity: 0;
    transition: opacity 0.8s ease-in;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-direction: column;
    overflow: hidden;
    animation: veil-ambient-flicker 0.1s steps(2) infinite;
}

.veil-overlay.veil-active {
    opacity: 1;
}

.veil-overlay.veil-exit {
    opacity: 0;
    transition: opacity 1.2s ease-out;
}

/* ── Ambient flicker ─────────────────────────────────────────────────────── */

@keyframes veil-ambient-flicker {
    0%,
    100% {
        opacity: 1;
    }

    50% {
        opacity: 0.97;
    }
}

/* Higher intensity flicker for later levels */
.veil-level-3.veil-active,
.veil-level-4.veil-active {
    animation: veil-ambient-flicker-strong 0.08s steps(2) infinite;
}

@keyframes veil-ambient-flicker-strong {
    0%,
    100% {
        opacity: 1;
    }

    25% {
        opacity: 0.95;
    }

    75% {
        opacity: 0.98;
    }
}

/* ── Static transition layer (reality tearing) ───────────────────────────── */

.veil-static-layer {
    position: absolute;
    inset: 0;
    background: #000000;
    z-index: 1;
    animation:
        veil-reality-tear 0.12s steps(5) infinite,
        veil-static-fade 2s ease-in forwards;
}

@keyframes veil-reality-tear {
    0% {
        background: repeating-linear-gradient(
            0deg,
            rgb(255 255 255 / 4%) 0,
            transparent 2px,
            transparent 4px
        );
        clip-path: inset(0 0 60% 0);
    }

    20% {
        background: repeating-linear-gradient(
            0deg,
            transparent 0,
            rgb(255 255 255 / 6%) 1px,
            transparent 3px
        );
        clip-path: inset(20% 0 30% 0);
    }

    40% {
        background: repeating-linear-gradient(
            0deg,
            rgb(255 255 255 / 3%) 0,
            transparent 1px,
            transparent 5px
        );
        clip-path: inset(40% 0 10% 0);
    }

    60% {
        background: repeating-linear-gradient(
            0deg,
            transparent 0,
            rgb(255 255 255 / 5%) 2px,
            transparent 4px
        );
        clip-path: inset(10% 0 50% 0);
    }

    80% {
        background: repeating-linear-gradient(
            0deg,
            rgb(255 255 255 / 2%) 0,
            transparent 2px,
            transparent 3px
        );
        clip-path: inset(0);
    }
}

@keyframes veil-static-fade {
    0% {
        opacity: 1;
    }

    60% {
        opacity: 0.8;
    }

    100% {
        opacity: 0;
    }
}

/* ── Canvas ──────────────────────────────────────────────────────────────── */

.veil-canvas {
    max-width: 100vw;
    max-height: 100vh;
    width: 800px;
    height: 600px;
    image-rendering: pixelated;
    opacity: 0;
    transition: opacity 0.5s ease-in;

    /* CRT curvature */
    border-radius: 12px;
    box-shadow:
        0 0 60px var(--veil-player-color, rgb(0 255 255 / 15%)),
        0 0 120px var(--veil-player-color, rgb(0 255 255 / 5%)),
        inset 0 0 40px rgb(0 0 0 / 50%);

    /* Chromatic aberration (slight RGB offset) */
    filter: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='ca'%3E%3CfeColorMatrix in='SourceGraphic' type='matrix' values='1 0 0 0 0 0 1 0 0 0 0 0 1 0 0 0 0 0 1 0' result='original'/%3E%3CfeOffset in='original' dx='1' dy='0' result='r'/%3E%3CfeOffset in='original' dx='-1' dy='0' result='b'/%3E%3CfeMerge%3E%3CfeMergeNode in='r'/%3E%3CfeMergeNode in='original'/%3E%3CfeMergeNode in='b'/%3E%3C/feMerge%3E%3C/filter%3E%3C/svg%3E%23ca");
}

.veil-canvas.veil-canvas-active {
    opacity: 1;
}

/* Stronger chromatic aberration for later levels */
.veil-level-3 .veil-canvas,
.veil-level-4 .veil-canvas {
    filter: none;
    text-shadow: -2px 0 red, 2px 0 cyan;
}

/* ── Scanline overlay ────────────────────────────────────────────────────── */

.veil-overlay::before {
    content: "";
    position: absolute;
    inset: 0;
    z-index: 2;
    pointer-events: none;
    background: repeating-linear-gradient(
        0deg,
        transparent 0,
        rgb(0 0 0 / 12%) 1px,
        transparent 2px,
        transparent 4px
    );
    animation: veil-scanline-scroll 8s linear infinite;
}

@keyframes veil-scanline-scroll {
    0% {
        background-position: 0 0;
    }

    100% {
        background-position: 0 8px;
    }
}

/* ── Vignette overlay ────────────────────────────────────────────────────── */

.veil-overlay::after {
    content: "";
    position: absolute;
    inset: 0;
    z-index: 3;
    pointer-events: none;
    background: radial-gradient(
        ellipse at center,
        transparent 40%,
        rgb(0 0 0 / var(--veil-intensity, 0.4)) 100%
    );
}

/* ── Per-level color accents ─────────────────────────────────────────────── */

.veil-level-0 {
    --accent: rgb(0 200 220 / 100%);
    --accent-dim: rgb(0 200 220 / 30%);
}

.veil-level-1 {
    --accent: rgb(200 100 255 / 100%);
    --accent-dim: rgb(200 100 255 / 30%);
}

.veil-level-2 {
    --accent: rgb(255 170 40 / 100%);
    --accent-dim: rgb(255 170 40 / 30%);
}

.veil-level-3 {
    --accent: rgb(60 255 100 / 100%);
    --accent-dim: rgb(60 255 100 / 30%);
}

.veil-level-4 {
    --accent: rgb(255 50 50 / 100%);
    --accent-dim: rgb(255 50 50 / 30%);
}

/* ── Dialogue ────────────────────────────────────────────────────────────── */

.veil-dialogue-container {
    width: 90%;
    max-width: 640px;
    max-height: 80vh;
    overflow-y: auto;
    opacity: 0;
    transition: opacity 0.6s ease-in;
    z-index: 5;
    scrollbar-width: thin;
    scrollbar-color: var(--accent-dim, rgb(0 255 128 / 30%)) transparent;
    border-left: 2px solid var(--accent-dim, rgb(0 255 128 / 15%));
    padding-left: 16px;
}

.veil-dialogue-container.veil-dialogue-active {
    opacity: 1;
}

.veil-dialogue {
    font-family: "Courier New", Courier, monospace;
    color: #00ff80;
    font-size: 15px;
    line-height: 1.6;
}

.veil-dialogue-node {
    margin-bottom: 16px;
    padding: 12px 0;
    border-bottom: 1px solid rgb(0 255 128 / 10%);
    cursor: pointer;
}

.veil-dialogue-entering {
    animation: veil-node-enter 0.3s ease-out forwards;
}

@keyframes veil-node-enter {
    0% {
        opacity: 0;
        transform: translateY(8px);
    }

    100% {
        opacity: 1;
        transform: translateY(0);
    }
}

.veil-dialogue-speaker {
    font-size: 12px;
    font-weight: bold;
    letter-spacing: 2px;
    margin-bottom: 6px;
    color: rgb(0 255 128 / 50%);
}

.veil-speaker-pferd {
    color: #ff4444;
    text-shadow: 0 0 8px rgb(255 0 0 / 30%);
}

.veil-speaker-unknown {
    color: rgb(0 255 128 / 50%);
    animation: veil-speaker-flicker 3s ease-in-out infinite;
}

@keyframes veil-speaker-flicker {
    0%,
    95%,
    100% {
        opacity: 1;
    }

    96% {
        opacity: 0.3;
    }

    97% {
        opacity: 0.8;
    }

    98% {
        opacity: 0.2;
    }
}

.veil-dialogue-text {
    min-height: 1.6em;
    overflow-wrap: break-word;
}

/* Typing cursor — only shown on the actively typing node */
.veil-dialogue-text.veil-dialogue-typing::after {
    content: "\2588";
    animation: veil-cursor-blink 0.6s steps(1) infinite;
    color: #00ff80;
}

@keyframes veil-cursor-blink {
    0%,
    49% {
        opacity: 1;
    }

    50%,
    100% {
        opacity: 0;
    }
}

/* ── Dialogue choices ────────────────────────────────────────────────────── */

.veil-dialogue-choices {
    margin-top: 12px;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

.veil-dialogue-choice-btn {
    background: transparent;
    border: 1px solid rgb(0 255 128 / 30%);
    color: #00ff80;
    font-family: "Courier New", Courier, monospace;
    font-size: 14px;
    padding: 8px 16px;
    text-align: left;
    cursor: pointer;
    transition:
        border-color 0.2s,
        background 0.2s,
        padding-left 0.2s;
}

.veil-choice-prefix {
    color: var(--accent, #00ff80);
    font-weight: bold;
    opacity: 0;
    display: inline-block;
    animation: veil-prefix-in 0.25s ease-out 0.1s forwards;
}

@keyframes veil-prefix-in {
    0% {
        opacity: 0;
        transform: translateX(-6px);
    }

    100% {
        opacity: 1;
        transform: translateX(0);
    }
}

.veil-dialogue-choice-btn:hover {
    border-color: #00ff80;
    background: rgb(0 255 128 / 10%);
    padding-left: 20px;
}

.veil-dialogue-choice-btn:focus {
    outline: 1px solid #00ff80;
    outline-offset: 2px;
}

.veil-choice-boss {
    border-color: rgb(255 68 68 / 50%);
    color: #ff4444;
}

.veil-choice-boss:hover {
    border-color: #ff4444;
    background: rgb(255 68 68 / 10%);
}

/* Disabled / selected choice states */
.veil-dialogue-choice-btn:disabled {
    cursor: default;
    opacity: 0.45;
    pointer-events: none;
}

.veil-dialogue-choice-btn.veil-choice-selected {
    border-color: #00ff80;
    background: rgb(0 255 128 / 12%);
    opacity: 1;
}

.veil-choice-boss.veil-choice-selected {
    border-color: #ff4444;
    background: rgb(255 68 68 / 12%);
    opacity: 1;
}

/* ── Retry prompt ────────────────────────────────────────────────────────── */

.veil-retry {
    text-align: center;
    z-index: 5;
    opacity: 0;
    transition: opacity 0.4s ease-in;
}

.veil-retry.veil-retry-active {
    opacity: 1;
}

.veil-retry-title {
    font-family: "Courier New", Courier, monospace;
    font-size: 48px;
    font-weight: bold;
    color: #ff4444;
    margin-bottom: 40px;
    text-shadow: 0 0 30px rgb(255 68 68 / 50%);
    letter-spacing: 8px;
    animation: veil-death-pulse 1.5s ease-in-out infinite;
}

@keyframes veil-death-pulse {
    0%,
    100% {
        text-shadow: 0 0 30px rgb(255 68 68 / 50%);
    }

    50% {
        text-shadow:
            0 0 50px rgb(255 68 68 / 80%),
            0 0 80px rgb(255 0 0 / 30%);
    }
}

.veil-retry-buttons {
    display: flex;
    gap: 24px;
    justify-content: center;
}

.veil-retry-btn {
    background: transparent;
    border: 2px solid;
    font-family: "Courier New", Courier, monospace;
    font-size: 18px;
    padding: 12px 32px;
    cursor: pointer;
    letter-spacing: 2px;
    transition:
        background 0.2s,
        transform 0.1s;
}

.veil-retry-btn:active {
    transform: scale(0.97);
}

.veil-btn-retry {
    border-color: var(--accent, #00ffff);
    color: var(--accent, #00ffff);
}

.veil-btn-retry:hover {
    background: var(--accent-dim, rgb(0 255 255 / 10%));
}

.veil-btn-exit {
    border-color: rgb(255 255 255 / 30%);
    color: rgb(255 255 255 / 50%);
}

.veil-btn-exit:hover {
    background: rgb(255 255 255 / 5%);
    color: rgb(255 255 255 / 80%);
}

/* ── Spooky effects (veil 3 reveal + boss dialogue) ──────────────────────── */

/* Red flicker on vampire horse reveal */
.veil-spooky-reveal {
    animation: veil-red-flicker 0.15s steps(2) 8 !important;
}

@keyframes veil-red-flicker {
    0%,
    100% {
        background: #000000;
    }

    50% {
        background: #1a0000;
    }
}

.veil-spooky-reveal .veil-dialogue {
    color: #ff3333;
    transition: color 0.3s;
}

.veil-spooky-reveal .veil-dialogue-speaker {
    color: #ff0000;
    text-shadow: 0 0 10px rgb(255 0 0 / 80%);
}

/* Static burst overlay */
.veil-static-burst {
    position: absolute;
    inset: 0;
    z-index: 10;
    pointer-events: none;
    animation: veil-burst 0.1s steps(3) 8;
    mix-blend-mode: screen;
}

@keyframes veil-burst {
    0% {
        background: repeating-linear-gradient(
            0deg,
            rgb(255 0 0 / 10%) 0,
            transparent 2px,
            transparent 3px
        );
    }

    33% {
        background: repeating-linear-gradient(
            0deg,
            transparent 0,
            rgb(255 255 255 / 15%) 1px,
            transparent 2px
        );
    }

    66% {
        background: repeating-linear-gradient(
            0deg,
            rgb(255 0 0 / 8%) 0,
            transparent 1px,
            transparent 4px
        );
    }
}

/* Text corruption glitch */
.veil-text-corrupt .veil-dialogue-text {
    animation: veil-text-glitch 0.08s steps(1) 15;
}

@keyframes veil-text-glitch {
    0%,
    80% {
        transform: none;
        opacity: 1;
    }

    20% {
        transform: skewX(-5deg) translateX(3px);
        opacity: 0.8;
    }

    40% {
        transform: skewX(3deg) translateX(-2px);
        opacity: 0.6;
    }

    60% {
        transform: skewX(-2deg);
        opacity: 0.9;
    }
}

/* Deep dread - plan reveal */
.veil-spooky-dread {
    background: #0a0000 !important;
    transition: background 1s;
}

.veil-spooky-dread .veil-dialogue {
    color: #cc4444;
    text-shadow: 0 0 4px rgb(255 0 0 / 30%);
}

/* Screen shake */
.veil-shake {
    animation: veil-shake-anim 0.08s steps(1) 8;
}

@keyframes veil-shake-anim {
    0%,
    100% {
        transform: translate(0, 0);
    }

    12% {
        transform: translate(-4px, 2px);
    }

    25% {
        transform: translate(3px, -3px);
    }

    37% {
        transform: translate(-2px, -1px);
    }

    50% {
        transform: translate(4px, 1px);
    }

    62% {
        transform: translate(-3px, 3px);
    }

    75% {
        transform: translate(2px, -2px);
    }

    87% {
        transform: translate(-1px, 1px);
    }
}

/* ── Replay flash ───────────────────────────────────────────────────────── */

.veil-replay-flash {
    font-family: "Courier New", Courier, monospace;
    font-size: 36px;
    font-weight: bold;
    color: var(--accent, #00ffff);
    letter-spacing: 6px;
    text-transform: uppercase;
    text-shadow: 0 0 30px var(--accent-dim, rgb(0 255 255 / 50%));
    opacity: 0;
    transition: opacity 0.3s ease-in;
    z-index: 5;
}

.veil-replay-flash.veil-replay-flash-active {
    opacity: 1;
    animation: veil-replay-pulse 0.6s ease-in-out 2;
}

@keyframes veil-replay-pulse {
    0%,
    100% {
        transform: scale(1);
        text-shadow: 0 0 30px var(--accent-dim, rgb(0 255 255 / 50%));
    }

    50% {
        transform: scale(1.05);
        text-shadow:
            0 0 50px var(--accent, rgb(0 255 255 / 80%)),
            0 0 80px var(--accent-dim, rgb(0 255 255 / 30%));
    }
}

/* ── Veil Widget ────────────────────────────────────────────────────────── */

.veil-widget {
    background: linear-gradient(180deg, #1a1a2e 0%, #0d0d1a 100%);
    border: 2px solid #1a1a3e;
    box-shadow:
        0 0 8px rgb(100 100 255 / 15%),
        inset 0 1px 0 rgb(100 100 255 / 10%);
}

.veil-widget .widget-titlebar {
    background: linear-gradient(180deg, #2a2a4a 0%, #1a1a2e 100%);
    font-family: "Courier New", Courier, monospace;
    font-size: 9px;
    letter-spacing: 3px;
    text-transform: uppercase;
    color: #aaaaff;
    text-shadow: 0 0 6px rgb(100 100 255 / 40%);
    border-bottom: 1px solid #1a1a3e;
}

.veil-widget .widget-btn {
    background: linear-gradient(180deg, #3a3a6a 0%, #2a2a4a 100%);
    border-color: #1a1a3e;
    color: #aaaaff;
}

.veil-widget .widget-btn:hover {
    background: linear-gradient(180deg, #4a4a7a 0%, #3a3a6a 100%);
    box-shadow: 0 0 4px rgb(100 100 255 / 40%);
}

.veil-widget-content {
    background: linear-gradient(180deg, #0d0d1a 0%, #06060f 100%);
    padding: 4px 6px;
}

.veil-widget-list {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.veil-widget-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 3px 4px;
    font-family: "Courier New", Courier, monospace;
    font-size: 10px;
    border-radius: 2px;
}

.veil-item-status {
    width: 14px;
    text-align: center;
    flex-shrink: 0;
    font-size: 10px;
}

.veil-item-name {
    flex: 1;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

/* Completed items */
.veil-item-completed {
    color: rgb(100 255 100 / 70%);
}

.veil-item-completed .veil-item-status {
    color: #00ff80;
    text-shadow: 0 0 4px rgb(0 255 128 / 50%);
}

/* Unlocked items - glow */
.veil-item-unlocked {
    color: #aaaaff;
}

.veil-item-glow {
    color: #aaaaff;
    text-shadow: 0 0 6px rgb(100 100 255 / 80%);
    animation: veil-widget-glow 2s ease-in-out infinite;
}

@keyframes veil-widget-glow {
    0%,
    100% {
        text-shadow: 0 0 6px rgb(100 100 255 / 80%);
    }

    50% {
        text-shadow:
            0 0 10px rgb(100 100 255 / 100%),
            0 0 16px rgb(100 100 255 / 40%);
    }
}

/* Locked items */
.veil-item-locked {
    color: rgb(255 255 255 / 45%);
}

.veil-item-locked .veil-item-status {
    font-size: 9px;
}

/* Widget buttons */
.veil-item-btn {
    background: transparent;
    border: 1px solid;
    font-family: "Courier New", Courier, monospace;
    font-size: 9px;
    padding: 1px 6px;
    cursor: pointer;
    border-radius: 2px;
    transition:
        background 0.15s,
        border-color 0.15s;
    flex-shrink: 0;
}

.veil-btn-replay {
    border-color: rgb(0 255 128 / 30%);
    color: rgb(0 255 128 / 60%);
}

.veil-btn-replay:hover {
    border-color: #00ff80;
    background: rgb(0 255 128 / 10%);
    color: #00ff80;
}

.veil-btn-pierce {
    border-color: rgb(100 100 255 / 50%);
    color: #aaaaff;
    animation: veil-widget-glow 2s ease-in-out infinite;
}

.veil-btn-pierce:hover {
    border-color: #aaaaff;
    background: rgb(100 100 255 / 15%);
}

/* ── Veil Unlock Modal ──────────────────────────────────────────────────── */

.veil-unlock-modal-overlay {
    position: fixed;
    inset: 0;
    z-index: 200000;
    background: rgb(0 0 0 / 0%);
    display: flex;
    align-items: center;
    justify-content: center;
    transition: background 0.4s ease-in;
}

.veil-unlock-modal-overlay.veil-unlock-modal-active {
    background: rgb(0 0 0 / 60%);
}

.veil-unlock-modal-overlay.veil-unlock-modal-exit {
    background: rgb(0 0 0 / 0%);
    transition: background 0.3s ease-out;
}

.veil-unlock-modal {
    background: linear-gradient(180deg, #0a0a1a 0%, #050510 100%);
    border: 1px solid rgb(100 100 255 / 30%);
    padding: 24px 32px;
    text-align: center;
    font-family: "Courier New", Courier, monospace;
    max-width: 320px;
    box-shadow:
        0 0 40px rgb(100 100 255 / 15%),
        0 0 80px rgb(100 100 255 / 5%),
        inset 0 0 20px rgb(0 0 0 / 50%);
    opacity: 0;
    transform: scale(0.95);
    transition:
        opacity 0.4s ease-in,
        transform 0.4s ease-in;
    animation: veil-modal-border-glitch 4s steps(2) infinite;
}

.veil-unlock-modal-active .veil-unlock-modal {
    opacity: 1;
    transform: scale(1);
}

.veil-unlock-modal-exit .veil-unlock-modal {
    opacity: 0;
    transform: scale(0.95);
    transition:
        opacity 0.3s ease-out,
        transform 0.3s ease-out;
}

@keyframes veil-modal-border-glitch {
    0%,
    97%,
    100% {
        border-color: rgb(100 100 255 / 30%);
    }

    98% {
        border-color: rgb(100 100 255 / 60%);
    }

    99% {
        border-color: rgb(100 100 255 / 15%);
    }
}

.veil-unlock-modal-title {
    font-size: 18px;
    color: #aaaaff;
    letter-spacing: 3px;
    margin-bottom: 8px;
    text-shadow: 0 0 10px rgb(100 100 255 / 40%);
}

.veil-unlock-modal-subtitle {
    font-size: 11px;
    color: rgb(255 255 255 / 55%);
    margin-bottom: 20px;
}

.veil-unlock-modal-buttons {
    display: flex;
    gap: 16px;
    justify-content: center;
}

.veil-unlock-modal-btn {
    background: transparent;
    border: 1px solid;
    font-family: "Courier New", Courier, monospace;
    font-size: 13px;
    padding: 8px 20px;
    cursor: pointer;
    letter-spacing: 1px;
    transition:
        background 0.2s,
        transform 0.1s;
}

.veil-unlock-modal-btn:active {
    transform: scale(0.97);
}

.veil-modal-btn-pierce {
    border-color: #aaaaff;
    color: #aaaaff;
}

.veil-modal-btn-pierce:hover {
    background: rgb(100 100 255 / 15%);
}

.veil-modal-btn-later {
    border-color: rgb(255 255 255 / 35%);
    color: rgb(255 255 255 / 55%);
}

.veil-modal-btn-later:hover {
    background: rgb(255 255 255 / 5%);
    color: rgb(255 255 255 / 60%);
}

/* ── Boss veil (4) ambient ───────────────────────────────────────────────── */

.veil-overlay.veil-boss-mode .veil-canvas {
    box-shadow:
        0 0 80px rgb(255 0 0 / 25%),
        0 0 160px rgb(255 0 0 / 10%),
        inset 0 0 40px rgb(0 0 0 / 50%);
    animation: veil-boss-pulse 2s ease-in-out infinite;
}

@keyframes veil-boss-pulse {
    0%,
    100% {
        box-shadow:
            0 0 80px rgb(255 0 0 / 25%),
            0 0 160px rgb(255 0 0 / 10%),
            inset 0 0 40px rgb(0 0 0 / 50%);
    }

    50% {
        box-shadow:
            0 0 120px rgb(255 0 0 / 40%),
            0 0 200px rgb(255 0 0 / 15%),
            inset 0 0 60px rgb(0 0 0 / 50%);
    }
}

/* Boss mode scanlines turn red */
.veil-overlay.veil-boss-mode::before {
    background: repeating-linear-gradient(
        0deg,
        transparent 0,
        rgb(255 0 0 / 6%) 1px,
        transparent 2px,
        transparent 4px
    );
}

/* Boss mode vignette intensifies */
.veil-overlay.veil-boss-mode::after {
    background: radial-gradient(
        ellipse at center,
        transparent 30%,
        rgb(20 0 0 / 70%) 100%
    );
}

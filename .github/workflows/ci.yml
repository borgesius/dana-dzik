name: CI

on:
    pull_request:
    push:
        branches: [main]
    merge_group:
        types: [checks_requested]

permissions:
    contents: read
    pull-requests: write
    statuses: write

jobs:
    lint-build-test:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Lint
              run: npm run lint

            - name: Typecheck
              run: npm run typecheck

            - name: Build
              run: npm run build

            - name: Unit Tests with Coverage
              run: npm run test:coverage

            - name: Post Coverage Status
              if: always()
              uses: actions/github-script@v7
              with:
                  script: |
                      const fs = require('fs');
                      try {
                          const summary = JSON.parse(fs.readFileSync('coverage/coverage-summary.json', 'utf8'));
                          const t = summary.total;
                          const desc = `Stmts: ${t.statements.pct}% | Branch: ${t.branches.pct}% | Func: ${t.functions.pct}% | Lines: ${t.lines.pct}%`;
                          await github.rest.repos.createCommitStatus({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              sha: context.sha,
                              state: 'success',
                              context: 'coverage',
                              description: desc,
                              target_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
                          });
                      } catch (e) {
                          console.log('Coverage status not posted:', e.message);
                      }

            - name: Coverage Report PR Comment
              uses: davelosert/vitest-coverage-report-action@v2
              if: github.event_name == 'pull_request'

            - name: Install Playwright browsers
              run: npx playwright install --with-deps chromium

            - name: E2E Tests
              run: npm run test:e2e

            - name: Playwright Report PR Comment
              uses: daun/playwright-report-summary@v3
              if: always() && github.event_name == 'pull_request'
              with:
                  report-file: playwright-report/results.json

            - name: Job Summary
              if: always()
              run: |
                  echo "## CI Results Summary" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY

                  echo "### Unit Tests & Coverage" >> $GITHUB_STEP_SUMMARY
                  if [ -f coverage/coverage-summary.json ]; then
                      TOTAL=$(node -e "const c=require('./coverage/coverage-summary.json').total; console.log('| Metric | Coverage |'); console.log('|---|---|'); console.log('| Statements | ' + c.statements.pct + '% |'); console.log('| Branches | ' + c.branches.pct + '% |'); console.log('| Functions | ' + c.functions.pct + '% |'); console.log('| Lines | ' + c.lines.pct + '% |');")
                      echo "$TOTAL" >> $GITHUB_STEP_SUMMARY
                  else
                      echo "Coverage data not available." >> $GITHUB_STEP_SUMMARY
                  fi

                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### E2E Tests (Playwright)" >> $GITHUB_STEP_SUMMARY
                  if [ -d playwright-report ]; then
                      echo "Playwright HTML report uploaded as artifact." >> $GITHUB_STEP_SUMMARY
                  else
                      echo "No Playwright report found." >> $GITHUB_STEP_SUMMARY
                  fi

            - name: Upload Playwright report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: playwright-report
                  path: playwright-report/
                  retention-days: 30

            - name: Upload Coverage report
              uses: actions/upload-artifact@v4
              if: always()
              with:
                  name: coverage-report
                  path: coverage/
                  retention-days: 30

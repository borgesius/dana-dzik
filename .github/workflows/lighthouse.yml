name: Lighthouse CI

on:
    pull_request:
    push:
        branches: [main]
    workflow_dispatch:

permissions:
    contents: read
    pull-requests: write

jobs:
    lighthouse:
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v4

            - name: Setup Node.js
              uses: actions/setup-node@v4
              with:
                  node-version: "20"
                  cache: "npm"

            - name: Install dependencies
              run: npm ci

            - name: Build
              run: npm run build

            - name: Run Lighthouse CI
              id: lhci
              uses: treosh/lighthouse-ci-action@v12
              with:
                  configPath: "./lighthouserc.json"
                  uploadArtifacts: true
                  temporaryPublicStorage: true

            - name: Parse Lighthouse Results
              id: lh_parse
              if: always()
              run: |
                  MANIFEST_PATH=$(find /tmp -name "manifest.json" -path "*/lhci*" 2>/dev/null | head -1)
                  if [ -z "$MANIFEST_PATH" ]; then
                      MANIFEST_PATH=$(find .lighthouseci -name "manifest.json" 2>/dev/null | head -1)
                  fi

                  if [ -n "$MANIFEST_PATH" ] && [ -f "$MANIFEST_PATH" ]; then
                      SCORES=$(node -e "
                          const fs = require('fs');
                          const manifest = JSON.parse(fs.readFileSync('$MANIFEST_PATH', 'utf8'));
                          const last = manifest[manifest.length - 1];
                          const lhr = JSON.parse(fs.readFileSync(last.jsonPath, 'utf8'));
                          const cats = lhr.categories;
                          const perf = Math.round(cats.performance.score * 100);
                          const a11y = Math.round(cats.accessibility.score * 100);
                          const bp = Math.round(cats['best-practices'].score * 100);
                          const seo = Math.round(cats.seo.score * 100);
                          const audits = lhr.audits;
                          const fcp = audits['first-contentful-paint'].displayValue || 'N/A';
                          const lcp = audits['largest-contentful-paint'].displayValue || 'N/A';
                          const cls = audits['cumulative-layout-shift'].displayValue || 'N/A';
                          const tbt = audits['total-blocking-time'].displayValue || 'N/A';
                          const si = audits['speed-index'].displayValue || 'N/A';
                          console.log(JSON.stringify({perf,a11y,bp,seo,fcp,lcp,cls,tbt,si}));
                      ")
                      echo "scores=$SCORES" >> $GITHUB_OUTPUT
                      echo "has_scores=true" >> $GITHUB_OUTPUT
                  else
                      echo "has_scores=false" >> $GITHUB_OUTPUT
                  fi

            - name: Lighthouse Job Summary
              if: always() && steps.lh_parse.outputs.has_scores == 'true'
              run: |
                  SCORES='${{ steps.lh_parse.outputs.scores }}'
                  PERF=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.perf)")
                  A11Y=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.a11y)")
                  BP=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.bp)")
                  SEO=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.seo)")
                  FCP=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.fcp)")
                  LCP=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.lcp)")
                  CLS=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.cls)")
                  TBT=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.tbt)")
                  SI=$(echo $SCORES | node -e "const s=JSON.parse(require('fs').readFileSync('/dev/stdin','utf8'));console.log(s.si)")

                  score_emoji() {
                      if [ "$1" -ge 90 ]; then echo "ðŸŸ¢"; elif [ "$1" -ge 50 ]; then echo "ðŸŸ "; else echo "ðŸ”´"; fi
                  }

                  echo "## Lighthouse Results" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Category | Score |" >> $GITHUB_STEP_SUMMARY
                  echo "|---|---|" >> $GITHUB_STEP_SUMMARY
                  echo "| $(score_emoji $PERF) Performance | **${PERF}** |" >> $GITHUB_STEP_SUMMARY
                  echo "| $(score_emoji $A11Y) Accessibility | **${A11Y}** |" >> $GITHUB_STEP_SUMMARY
                  echo "| $(score_emoji $BP) Best Practices | **${BP}** |" >> $GITHUB_STEP_SUMMARY
                  echo "| $(score_emoji $SEO) SEO | **${SEO}** |" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "### Web Vitals" >> $GITHUB_STEP_SUMMARY
                  echo "" >> $GITHUB_STEP_SUMMARY
                  echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
                  echo "|---|---|" >> $GITHUB_STEP_SUMMARY
                  echo "| First Contentful Paint | ${FCP} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Largest Contentful Paint | ${LCP} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Cumulative Layout Shift | ${CLS} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Total Blocking Time | ${TBT} |" >> $GITHUB_STEP_SUMMARY
                  echo "| Speed Index | ${SI} |" >> $GITHUB_STEP_SUMMARY

            - name: Lighthouse PR Comment
              if: always() && github.event_name == 'pull_request' && steps.lh_parse.outputs.has_scores == 'true'
              uses: actions/github-script@v7
              with:
                  script: |
                      const scores = JSON.parse('${{ steps.lh_parse.outputs.scores }}');
                      const emoji = (s) => s >= 90 ? 'ðŸŸ¢' : s >= 50 ? 'ðŸŸ ' : 'ðŸ”´';
                      const body = [
                          '## Lighthouse Report',
                          '',
                          '| Category | Score |',
                          '|---|---|',
                          `| ${emoji(scores.perf)} Performance | **${scores.perf}** |`,
                          `| ${emoji(scores.a11y)} Accessibility | **${scores.a11y}** |`,
                          `| ${emoji(scores.bp)} Best Practices | **${scores.bp}** |`,
                          `| ${emoji(scores.seo)} SEO | **${scores.seo}** |`,
                          '',
                          '### Web Vitals',
                          '',
                          '| Metric | Value |',
                          '|---|---|',
                          `| First Contentful Paint | ${scores.fcp} |`,
                          `| Largest Contentful Paint | ${scores.lcp} |`,
                          `| Cumulative Layout Shift | ${scores.cls} |`,
                          `| Total Blocking Time | ${scores.tbt} |`,
                          `| Speed Index | ${scores.si} |`,
                      ].join('\n');

                      const { data: comments } = await github.rest.issues.listComments({
                          owner: context.repo.owner,
                          repo: context.repo.repo,
                          issue_number: context.issue.number,
                      });
                      const existing = comments.find(c => c.body?.startsWith('## Lighthouse Report'));
                      if (existing) {
                          await github.rest.issues.updateComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              comment_id: existing.id,
                              body,
                          });
                      } else {
                          await github.rest.issues.createComment({
                              owner: context.repo.owner,
                              repo: context.repo.repo,
                              issue_number: context.issue.number,
                              body,
                          });
                      }
